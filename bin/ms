#! /bin/bash

# --------------------- Quick Commands ---------------------
# ğŸš€ å¯åŠ¨æœåŠ¡:
#    bash model.sh start qwen_server -m "Qwen3-14B" -p 6544 -g 1
# ğŸ“Š æŸ¥çœ‹çŠ¶æ€:
#    bash model.sh status
# ğŸ›‘ åœæ­¢æœåŠ¡:
#    bash model.sh stop qwen_server
# ğŸ“œ æŸ¥çœ‹æ—¥å¿—:
#    bash model.sh logs qwen_server
# ğŸ—‘ï¸ åˆ é™¤æ—¥å¿—:
#    bash model.sh delete qwen_server
# ----------------------------------------------------------


PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." &> /dev/null && pwd )"
cd ${PROJECT_DIR}

# --- Conda ç¯å¢ƒè‡ªåŠ¨è¯†åˆ« ---
# è‡ªåŠ¨æŸ¥æ‰¾ Conda çš„ activate è„šæœ¬
CONDA_ACTIVATE_SCRIPT=""
if command -v conda &> /dev/null; then
    # å¦‚æœ conda å‘½ä»¤åœ¨ PATH ä¸­ï¼Œè¿™æ˜¯æœ€ç†æƒ³çš„æƒ…å†µ
    CONDA_BASE_DIR=$(conda info --base)
    CONDA_ACTIVATE_SCRIPT="${CONDA_BASE_DIR}/bin/activate"
elif [ -d "${HOME}/miniconda3" ]; then
    # æŸ¥æ‰¾å¸¸è§çš„ miniconda3 è·¯å¾„
    CONDA_ACTIVATE_SCRIPT="${HOME}/miniconda3/bin/activate"
elif [ -d "${HOME}/anaconda3" ]; then
    # æŸ¥æ‰¾å¸¸è§çš„ anaconda3 è·¯å¾„
    CONDA_ACTIVATE_SCRIPT="${HOME}/anaconda3/bin/activate"
fi

# ä¸»Pythonè„šæœ¬
SCRIPT_NAME="modelServer.py"
# ç”¨äºå­˜æ”¾æ‰€æœ‰å®ä¾‹ç›¸å…³æ–‡ä»¶ï¼ˆé…ç½®, pid, æ—¥å¿—ï¼‰çš„ç›®å½•
INSTANCE_DIR="logs"

# --- é»˜è®¤å‚æ•° ---
DEFAULT_MODEL_NAME="Qwen2.5-VL-7B"
DEFAULT_PORT=9960
DEFAULT_GPU_ID="0"
# å¯åŠ¨è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå¯ä»¥æ ¹æ®æ¨¡å‹å¤§å°é€‚å½“è°ƒæ•´
START_TIMEOUT=1800 # 30åˆ†é’Ÿ

# --- é¢œè‰²å®šä¹‰ ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ç¡®ä¿å®ä¾‹ç›®å½•å­˜åœ¨
mkdir -p "$INSTANCE_DIR"

# --- å¸®åŠ©ä¿¡æ¯ ---
usage() {
    echo -e "${YELLOW}æ™ºèƒ½å¤šå®ä¾‹æœåŠ¡ç®¡ç†è„šæœ¬${NC}"
    echo ""
    echo -e "${BLUE}ç”¨æ³•: $0 <å‘½ä»¤> [å®ä¾‹å] [é€‰é¡¹]...${NC}"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  start   <å®ä¾‹å>    å¯åŠ¨ä¸€ä¸ªæ–°çš„æœåŠ¡å®ä¾‹ (å°†äº¤äº’å¼é€‰æ‹©Condaç¯å¢ƒ)"
    echo "  stop    <å®ä¾‹å>    åœæ­¢ä¸€ä¸ªæŒ‡å®šçš„æœåŠ¡å®ä¾‹"
    echo "  restart <å®ä¾‹å>    é‡å¯ä¸€ä¸ªæŒ‡å®šçš„æœåŠ¡å®ä¾‹ï¼ˆä½¿ç”¨åŸé…ç½®ï¼‰"
    echo "  status  [å®ä¾‹å]    æŸ¥çœ‹æŒ‡å®šå®ä¾‹æˆ–æ‰€æœ‰å®ä¾‹çš„çŠ¶æ€"
    echo "  logs    <å®ä¾‹å>    å®æ—¶æŸ¥çœ‹æŒ‡å®šå®ä¾‹çš„æ—¥å¿—"
    echo "  delete  <å®ä¾‹å>    åœæ­¢å¹¶å½»åº•åˆ é™¤ä¸€ä¸ªå®ä¾‹çš„é…ç½®å’Œæ—¥å¿—"
    echo ""
    echo -e "${YELLOW}å¯åŠ¨é€‰é¡¹ (ä»…ç”¨äº 'start' å‘½ä»¤):${NC}"
    echo "  -m, --model <æ¨¡å‹å>    æŒ‡å®šè¦åŠ è½½çš„æ¨¡å‹ (é»˜è®¤: ${DEFAULT_MODEL_NAME})"
    echo "  -p, --port  <ç«¯å£å·>    æŒ‡å®šæœåŠ¡ç›‘å¬çš„ç«¯å£ (é»˜è®¤: ${DEFAULT_PORT})"
    echo "  -g, --gpu   <GPU_ID>    æŒ‡å®šä½¿ç”¨çš„GPU ID (é»˜è®¤: ${DEFAULT_GPU_ID})"
    echo "  -w, --weight_path <è·¯å¾„> æŒ‡å®šæ¨¡å‹æƒé‡è·¯å¾„ (å¯é€‰)"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  # å¯åŠ¨ä¸€ä¸ªåä¸º 'api_server_1' çš„å®ä¾‹ï¼Œä½¿ç”¨GPU 1ï¼Œç«¯å£8001"
    echo "  $0 start api_server_1 -m Qwen3-14B -g 1 -p 8001"
    echo ""
    echo "  # æŸ¥çœ‹æ‰€æœ‰å®ä¾‹çš„çŠ¶æ€"
    echo "  $0 status"
    echo ""
    echo "  # åœæ­¢ 'api_server_1' å®ä¾‹"
    echo "  $0 stop api_server_1"
    exit 1
}

# --- å†…éƒ¨å‡½æ•° ---

# æ£€æŸ¥å®ä¾‹æ˜¯å¦æ­£åœ¨è¿è¡Œ
is_running() {
    local instance_name=$1
    local pid_file="${INSTANCE_DIR}/${instance_name}/${instance_name}.pid"
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if [ -n "$pid" ] && ps -p "$pid" > /dev/null; then
            return 0 # æ­£åœ¨è¿è¡Œ
        fi
    fi
    return 1 # æœªè¿è¡Œ
}

# æ¿€æ´» Conda ç¯å¢ƒçš„è¾…åŠ©å‡½æ•°
activate_env() {
    local env_name=$1
    if [ -z "$CONDA_ACTIVATE_SCRIPT" ]; then
        echo -e "${RED}é”™è¯¯: æ— æ³•æ‰¾åˆ° Conda çš„ activate è„šæœ¬ã€‚è¯·ç¡®ä¿ Conda å·²æ­£ç¡®å®‰è£…å¹¶åˆå§‹åŒ–ã€‚${NC}"
        exit 1
    fi
    echo "source ${CONDA_ACTIVATE_SCRIPT} ${env_name}"
}


# å¯åŠ¨æœåŠ¡
# ã€é‡è¦æ”¹åŠ¨ã€‘: å¢åŠ äº†ä¸€ä¸ªéšè—çš„ -e å‚æ•°ï¼Œä¸“é—¨ç»™ restart å‘½ä»¤ä½¿ç”¨
do_start() {
    local instance_name=$1
    shift
    
    # è§£æé€‰é¡¹å‚æ•°
    local model_name=$DEFAULT_MODEL_NAME
    local port=$DEFAULT_PORT
    local gpu_id=$DEFAULT_GPU_ID
    local conda_env_name="" # é»˜è®¤condaç¯å¢ƒä¸ºç©º
    local weight_path=""
    while [[ "$#" -gt 0 ]]; do
        case $1 in
            -m|--model) model_name="$2"; shift ;;
            -p|--port) port="$2"; shift ;;
            -g|--gpu) gpu_id="$2"; shift ;;
            -e|--env) conda_env_name="$2"; shift ;; # éšè—å‚æ•°ï¼Œä¾›restartè°ƒç”¨
            -w|--weight_path) weight_path="$2"; shift ;;
            *) echo -e "${RED}é”™è¯¯: 'start' å‘½ä»¤é‡åˆ°æœªçŸ¥é€‰é¡¹: $1${NC}"; usage ;;
        esac
        shift
    done

    local instance_path="${INSTANCE_DIR}/${instance_name}"
    local conf_file="${instance_path}/${instance_name}.conf"
    local pid_file="${instance_path}/${instance_name}.pid"
    local log_file="${instance_path}/${instance_name}.log"

    if is_running "$instance_name"; then
        local pid=$(cat "$pid_file")
        echo -e "${YELLOW}å®ä¾‹ '${instance_name}' å·²åœ¨è¿è¡Œä¸­, PID: ${pid}${NC}"
        exit 0
    fi

    # ã€æ ¸å¿ƒäº¤äº’é€»è¾‘ã€‘
    # å¦‚æœ conda_env_name ä¸ºç©º (å³ç”¨æˆ·ç›´æ¥è°ƒç”¨ start)ï¼Œåˆ™è¿›å…¥äº¤äº’æ¨¡å¼
    if [ -z "$conda_env_name" ]; then
        echo -e "${YELLOW}æ­£åœ¨æ£€æµ‹å¯ç”¨çš„ Conda ç¯å¢ƒ...${NC}"
        
        # è·å–condaç¯å¢ƒåˆ—è¡¨å¹¶å­˜å…¥æ•°ç»„
        # ä½¿ç”¨ process substitution å’Œ mapfile æ¥å®‰å…¨å¤„ç†å¸¦ç©ºæ ¼çš„è·¯å¾„
        mapfile -t conda_envs < <(conda env list | grep -v '^#' | awk '{print $1}' | sed '/^$/d')

        if [ ${#conda_envs[@]} -eq 0 ]; then
            echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½• Conda ç¯å¢ƒã€‚è¯·å…ˆåˆ›å»º Conda ç¯å¢ƒã€‚${NC}"
            exit 1
        fi

        echo -e "${BLUE}å‘ç°ä»¥ä¸‹ Conda ç¯å¢ƒ:${NC}"
        for i in "${!conda_envs[@]}"; do
            printf "  %2d) %s\n" "$((i+1))" "${conda_envs[$i]}"
        done

        local choice
        while true; do
            read -p "è¯·é€‰æ‹©è¦ä½¿ç”¨çš„ç¯å¢ƒåºå· [1-${#conda_envs[@]}]: " choice
            if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#conda_envs[@]}" ]; then
                conda_env_name=${conda_envs[$((choice-1))]}
                echo -e "å·²é€‰æ‹©ç¯å¢ƒ: ${GREEN}${conda_env_name}${NC}"
                break
            else
                echo -e "${RED}è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ 1 åˆ° ${#conda_envs[@]} ä¹‹é—´çš„æ•°å­—ã€‚${NC}"
            fi
        done
    fi


    # åˆ›å»ºå®ä¾‹ç‰¹å®šç›®å½•å¹¶æ¸…ç©ºæ—§æ—¥å¿—
    mkdir -p "$instance_path"
    > "$log_file"

    # ä¿å­˜é…ç½® (åŒ…æ‹¬é€‰æ‹©çš„ CONDA_ENV_NAME)
    echo "MODEL_NAME=\"${model_name}\"" > "$conf_file"
    echo "PORT=${port}" >> "$conf_file"
    echo "GPU_ID=${gpu_id}" >> "$conf_file"
    echo "CONDA_ENV_NAME=${conda_env_name}" >> "$conf_file"
    echo "WEIGHT_PATH=${weight_path}" >> "$conf_file"
    echo -e "æ­£åœ¨å¯åŠ¨å®ä¾‹ '${BLUE}${instance_name}${NC}'..."
    echo -e "  - Conda ç¯å¢ƒ: ${conda_env_name}"
    echo -e "  - æ¨¡å‹: ${model_name}"
    echo -e "  - æƒé‡è·¯å¾„: ${weight_path}"
    echo -e "  - ç«¯å£: ${port}"
    echo -e "  - GPU ID: ${gpu_id}"
    echo -e "  - æ—¥å¿—æ–‡ä»¶: ${log_file}"
    # è·å–æ¿€æ´»å‘½ä»¤
    local activate_cmd
    activate_cmd=$(activate_env "$conda_env_name")
    if [ $? -ne 0 ]; then exit 1; fi

    # æ„å»ºåœ¨åå°æ‰§è¡Œçš„å®Œæ•´å‘½ä»¤
    local weight_arg=""
    if [ -n "$weight_path" ]; then
        weight_arg="--weight_path \"${weight_path}\""
    fi
    local full_command="export CUDA_VISIBLE_DEVICES=${gpu_id}; export OMP_NUM_THREADS=8; ${activate_cmd} && python -u \"$SCRIPT_NAME\" --model \"${model_name}\" --port ${port} ${weight_arg}"
    
    # åå°å¯åŠ¨Pythonè„šæœ¬
    nohup bash -c "${full_command}" > "$log_file" 2>&1 &
    local pid=$!
    echo "$pid" > "$pid_file"

    # --- ç­‰å¾…å¹¶éªŒè¯æœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨ (é€»è¾‘ä¸å˜) ---
    echo -n "ç­‰å¾…æœåŠ¡åˆå§‹åŒ– (æœ€é•¿ ${START_TIMEOUT} ç§’) "
    local count=0
    local success=false
    while [ "$count" -lt "$START_TIMEOUT" ]; do
        if ! is_running "$instance_name"; then
            if grep -q "Could not find conda environment" "$log_file"; then
                 echo -e "\n${RED}é”™è¯¯: Conda ç¯å¢ƒ '${conda_env_name}' ä¸å­˜åœ¨æˆ–æ— æ³•æ¿€æ´»!${NC}"
            else
                 echo -e "\n${RED}é”™è¯¯: è¿›ç¨‹åœ¨åˆå§‹åŒ–æœŸé—´æ„å¤–é€€å‡º!${NC}"
            fi
            break
        fi

        if grep -q "Test Successfully!" "$log_file"; then
            success=true
            echo -e "\n${GREEN}æœåŠ¡å·²æˆåŠŸåˆå§‹åŒ–!${NC}"
            break
        fi
        
        echo -n "."
        sleep 5
        ((count+=5))
    done

    # --- æ ¹æ®éªŒè¯ç»“æœè¿›è¡Œæœ€ç»ˆå¤„ç† (é€»è¾‘ä¸å˜) ---
    if [ "$success" = true ]; then
        echo -e "${GREEN}å®ä¾‹ '${instance_name}' å¯åŠ¨æˆåŠŸ! PID: ${pid}${NC}"
    else
        if [ "$count" -ge "$START_TIMEOUT" ]; then
            echo -e "\n${RED}é”™è¯¯: ç­‰å¾…æœåŠ¡åˆå§‹åŒ–è¶…æ—¶ (${START_TIMEOUT}ç§’)!${NC}"
        fi
        echo -e "${RED}å®ä¾‹ '${instance_name}' å¯åŠ¨å¤±è´¥!${NC}"
        echo -e "è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯: ${BLUE}tail -n 50 ${log_file}${NC}"
        
        echo -e "æ­£åœ¨æ¸…ç†å¤±è´¥çš„è¿›ç¨‹ (PID: ${pid})..."
        kill -9 "$pid" > /dev/null 2>&1
        rm -f "$pid_file"
        exit 1
    fi
}

# åœæ­¢æœåŠ¡ (é€»è¾‘ä¸å˜)
do_stop() {
    local instance_name=$1
    local pid_file="${INSTANCE_DIR}/${instance_name}/${instance_name}.pid"

    if ! is_running "$instance_name"; then
        echo -e "${YELLOW}å®ä¾‹ '${instance_name}' æœªåœ¨è¿è¡Œä¸­ã€‚${NC}"
        [ -f "$pid_file" ] && rm -f "$pid_file"
        return 0
    fi

    local pid=$(cat "$pid_file")
    echo -e "æ­£åœ¨åœæ­¢å®ä¾‹ '${instance_name}' (PID: ${pid})..."
    pkill -P "$pid"
    kill "$pid"

    local count=0
    while is_running "$instance_name"; do
        if [ "$count" -lt 10 ]; then
            sleep 1; ((count++)); echo -n "."
        else
            echo -e "\n${YELLOW}è¿›ç¨‹æœªèƒ½æ­£å¸¸åœæ­¢, å¼ºåˆ¶ç»ˆæ­¢ (kill -9)...${NC}"
            pkill -9 -P "$pid"
            kill -9 "$pid"
            sleep 1
            break
        fi
    done
    echo -e "\n${GREEN}å®ä¾‹ '${instance_name}' å·²åœæ­¢ã€‚${NC}"
    rm -f "$pid_file"
}

# æŸ¥çœ‹çŠ¶æ€ (é€»è¾‘ä¸å˜, ä¹‹å‰å·²æ”¯æŒæ˜¾ç¤ºCondaç¯å¢ƒ)
do_status() {
    local instance_name=$1
    if [ -z "$instance_name" ]; then
        echo -e "${BLUE}--- æ‰€æœ‰æ‰˜ç®¡çš„æœåŠ¡å®ä¾‹çŠ¶æ€ ---${NC}"
        if [ -z "$(ls -A $INSTANCE_DIR)" ]; then
            echo "å½“å‰æ²¡æœ‰æ‰˜ç®¡ä»»ä½•å®ä¾‹ã€‚"
            return
        fi
        printf "%-20s %-10s %-10s %-20s %-25s %-10s %-10s\n" "å®ä¾‹å" "çŠ¶æ€" "PID" "Condaç¯å¢ƒ" "æ¨¡å‹" "ç«¯å£" "GPU"
        echo "------------------------------------------------------------------------------------------------------------------------"
        for d in ${INSTANCE_DIR}/*; do
            if [ -d "$d" ]; then
                local name=$(basename "$d")
                local conf_file="${d}/${name}.conf"
                if [ -f "$conf_file" ]; then
                    local MODEL_NAME PORT GPU_ID CONDA_ENV_NAME
                    source "$conf_file" # åŠ è½½é…ç½®
                    if is_running "$name"; then
                        local pid=$(cat "${d}/${name}.pid")
                        printf "${YELLOW}%-20s ${GREEN}%-10s${NC} %-10s ${BLUE}%-20s${NC} ${YELLOW}%-25s${NC} %-10s %-10s\n" "$name" "è¿è¡Œä¸­" "$pid" "$CONDA_ENV_NAME" "$MODEL_NAME" "$PORT" "$GPU_ID"
                    else
                        printf "${YELLOW}%-20s ${RED}%-10s${NC} %-10s ${BLUE}%-20s${NC} ${YELLOW}%-25s${NC} %-10s %-10s\n" "$name" "å·²åœæ­¢" "N/A" "$CONDA_ENV_NAME" "$MODEL_NAME" "$PORT" "$GPU_ID"
                    fi
                fi
            fi
        done
    else
        local conf_file="${INSTANCE_DIR}/${instance_name}/${instance_name}.conf"
        if [ ! -f "$conf_file" ]; then
            echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ°å®ä¾‹ '${instance_name}' çš„é…ç½®ã€‚${NC}"
            exit 1
        fi
        local MODEL_NAME PORT GPU_ID CONDA_ENV_NAME WEIGHT_PATH
        source "$conf_file" # åŠ è½½é…ç½®
        echo -e "${BLUE}--- å®ä¾‹ '${instance_name}' çŠ¶æ€ ---${NC}"
        if is_running "$instance_name"; then
            local pid=$(cat "${INSTANCE_DIR}/${instance_name}/${instance_name}.pid")
            echo -e "çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${NC}"
            echo -e "PID: ${pid}"
        else
            echo -e "çŠ¶æ€: ${RED}å·²åœæ­¢${NC}"
        fi
        echo "Condaç¯å¢ƒ: ${CONDA_ENV_NAME}"
        echo "æ¨¡å‹: ${MODEL_NAME}"
        if [ -n "$WEIGHT_PATH" ]; then
            echo "æƒé‡è·¯å¾„: ${WEIGHT_PATH}"
        fi
        echo "ç«¯å£: ${PORT}"
        echo "GPU:  ${GPU_ID}"
    fi
}

# åˆ é™¤å®ä¾‹ (é€»è¾‘ä¸å˜)
do_delete() {
    local instance_name=$1
    local instance_path="${INSTANCE_DIR}/${instance_name}"

    if [ ! -d "$instance_path" ]; then
        echo -e "${YELLOW}å®ä¾‹ '${instance_name}' ä¸å­˜åœ¨ã€‚${NC}"
        return
    fi
    
    if is_running "$instance_name"; then
        echo -e "${YELLOW}å®ä¾‹ '${instance_name}' æ­£åœ¨è¿è¡Œï¼Œå°†å…ˆåœæ­¢å®ƒ...${NC}"
        do_stop "$instance_name"
    fi

    read -p "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å®ä¾‹ '${instance_name}' çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ(åŒ…æ‹¬é…ç½®å’Œæ—¥å¿—) [y/N]: " confirm
    if [[ "$confirm" =~ ^[yY]([eE][sS])?$ ]]; then
        rm -rf "$instance_path"
        echo -e "${GREEN}å®ä¾‹ '${instance_name}' å·²è¢«æˆåŠŸåˆ é™¤ã€‚${NC}"
    else
        echo "æ“ä½œå·²å–æ¶ˆã€‚"
    fi
}


# --- ä¸»é€»è¾‘ ---
COMMAND=$1
INSTANCE_NAME=$2

# ... (ä¸»é€»è¾‘éƒ¨åˆ†ä¸å˜) ...
if [[ -z "$COMMAND" || "$COMMAND" == "-h" || "$COMMAND" == "--help" ]]; then
    usage
fi

case "$COMMAND" in
    start|stop|restart|logs|delete)
        if [ -z "$INSTANCE_NAME" ]; then
            echo -e "${RED}é”™è¯¯: å‘½ä»¤ '${COMMAND}' éœ€è¦ä¸€ä¸ª [å®ä¾‹å]ã€‚${NC}"
            usage
        fi
        ;;
    status)
        ;;
    *)
        echo -e "${RED}é”™è¯¯: æœªçŸ¥å‘½ä»¤ '${COMMAND}'${NC}"
        usage
        ;;
esac

# æ‰§è¡Œå‘½ä»¤
case "$COMMAND" in
    start)
        shift 2
        do_start "$INSTANCE_NAME" "$@"
        ;;
    stop)
        do_stop "$INSTANCE_NAME"
        ;;
    restart)
        echo "æ­£åœ¨é‡å¯å®ä¾‹ '${INSTANCE_NAME}'..."
        conf_file="${INSTANCE_DIR}/${INSTANCE_NAME}/${INSTANCE_NAME}.conf"
        if [ ! -f "$conf_file" ]; then
            echo -e "${RED}é”™è¯¯: æ‰¾ä¸åˆ°å®ä¾‹ '${INSTANCE_NAME}' çš„é…ç½®, æ— æ³•é‡å¯ã€‚è¯·å…ˆä½¿ç”¨ 'start' å‘½ä»¤åˆ›å»ºã€‚${NC}"
            exit 1
        fi
        do_stop "$INSTANCE_NAME"
        sleep 1
        
        # ã€é‡è¦æ”¹åŠ¨ã€‘: restart ä»é…ç½®æ–‡ä»¶åŠ è½½æ‰€æœ‰å‚æ•°ï¼ŒåŒ…æ‹¬ CONDA_ENV_NAME
        # å¹¶é€šè¿‡éšè—çš„ -e å‚æ•°ä¼ é€’ç»™ do_startï¼Œä»¥è·³è¿‡äº¤äº’é€‰æ‹©
        local MODEL_NAME PORT GPU_ID CONDA_ENV_NAME WEIGHT_PATH
        source "$conf_file"
        if [ -n "$WEIGHT_PATH" ]; then
            do_start "$INSTANCE_NAME" -m "$MODEL_NAME" -p "$PORT" -g "$GPU_ID" -e "$CONDA_ENV_NAME" -w "$WEIGHT_PATH"
        else
            do_start "$INSTANCE_NAME" -m "$MODEL_NAME" -p "$PORT" -g "$GPU_ID" -e "$CONDA_ENV_NAME"
        fi
        ;;
    status)
        do_status "$INSTANCE_NAME"
        ;;
    logs)
        log_file="${INSTANCE_DIR}/${INSTANCE_NAME}/${INSTANCE_NAME}.log"
        if [ ! -f "$log_file" ]; then
            echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ°å®ä¾‹ '${INSTANCE_NAME}' çš„æ—¥å¿—æ–‡ä»¶ã€‚${NC}"
            exit 1
        fi
        echo "æŒ‰ CTRL+C åœæ­¢æŸ¥çœ‹æ—¥å¿—ã€‚"
        tail -f "$log_file"
        ;;
    delete)
        do_delete "$INSTANCE_NAME"
        ;;
esac